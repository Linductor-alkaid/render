# Mesh 切线空间集成方案

## 概述

本文档记录 Phase 1 模型渲染阶段针对切线空间的改进方案，覆盖了 Mesh、MeshLoader 以及渲染着色器的改动要点，并总结了后续扩展工作。

## 现状与问题

- 旧版 `Mesh::RecalculateTangents()` 仅提供空实现，无法支持法线贴图。
- `MeshLoader` 在导入（或 procedural 生成）网格时不会填充切线数据。
- 顶点布局缺少切线/副切线，着色器端无法接收或使用。
- 文档对于切线空间流程缺乏说明，计划文档未列出对应任务。

## 已完成的改进

1. **顶点结构扩展**  
   - `Vertex` 增加 `tangent` / `bitangent` 字段，默认提供稳定的初始化值。  
   - `Mesh::SetupVertexAttributes()` 更新为 6 个通道（位置、UV、法线、颜色、切线、副切线）。

2. **切线计算实现**  
   - `Mesh::RecalculateTangents()` 基于三角形和 UV 导数计算切线、副切线，并对结果进行正交化。
   - 兼容索引/非索引网格，自动跳过退化面，支持已上传网格的 GPU 数据同步。

3. **资源导入与生成**  
   - `MeshLoader` 在导入外部模型时，如缺少切线数据会调用 `RecalculateTangents()`；若已有切线，则进行正交化与一致化处理。  
   - 所有基础几何创建接口在生成顶点后统一调用 `RecalculateTangents()`，保证 procedural mesh 具备完整切线空间。

4. **API 文档更新**  
   - `docs/api/Mesh.md` 补充了 `Vertex` 的新字段和 `RecalculateTangents()` 的实现细节。  
   - `docs/api/MeshLoader.md` 标注自动切线空间生成能力，方便查阅。

## 待办与后续计划

- **着色器阶段**：
  - 为 `material_phong` 等着色器补充切线空间输出（TBN 矩阵）与法线贴图采样逻辑。
  - 确认并更新 `UniformManager` 中与法线贴图相关的 uniform 定义。

- **资源资产**：
  - 在资源管理器中登记法线贴图示例，确保 CMake 注册新纹理时同步更新。

- **工具链与调试**：
  - 为 `Mesh` 提供调试可视化（例如在 Debug 层绘制切线箭头）。
  - 编写单元测试或离线校验脚本，验证切线方向与手性一致性。

- **文档扩展**：
  - 在 Phase 1 任务清单中加入法线贴图与切线空间验证步骤。  
  - 追加一份针对材质系统的法线贴图接入指南，便于美术/内容团队协作。

## 测试建议

- 假设条件：已存在开启法线贴图路径的着色器或调试脚本。  
- 测试步骤：
  1. 使用 `MeshLoader::CreateCube()` 和导入的复杂模型分别渲染，启用法线贴图。  
  2. 在不同缩放、旋转下检查高光与凹凸是否稳定。  
  3. 开启双面材质验证副切线方向，确保没有面翻转伪影。  

- 验证工具：使用 RenderDoc 检查 TBN 矩阵以及片段阶段的世界空间法线。

---

> 更新日期：2025-11-09  
> 负责人：渲染系统组

