# ECS 综合功能测试 - 35_ecs_comprehensive_test

## 📋 概述

这是一个全面的 ECS 系统测试程序，用于验证所有新增功能，并渲染 20 个几何形状测试样例（5 种形状：Cube、Sphere、Cylinder、Cone、Torus）。

## ✨ 测试内容

### 1. 新增系统测试

- **WindowSystem** (优先级 3)
  - 自动检测窗口大小变化
  - 自动更新相机宽高比
  - 自动更新视口

- **GeometrySystem** (优先级 15)
  - 程序化生成基本几何形状
  - 测试形状：地板（Cube）、球体（Sphere）、圆柱体（Cylinder）

- **UniformSystem** (优先级 90)
  - 自动管理相机 uniform（uViewMatrix、uProjectionMatrix、uCameraPosition）
  - 自动管理光照 uniform（uLightDirection、uLightColor、uLightIntensity）
  - 自动管理时间 uniform（uTime、uDeltaTime）

- **ResourceCleanupSystem** (优先级 1000)
  - 定期清理未使用的资源
  - 防止内存泄漏
  - 提供清理统计信息

### 2. 材质属性覆盖测试

20 个 miku 模型分为 4 组，每组 5 个样例：

#### 第 1 行（索引 0-4）：颜色测试
- 使用不同色相的颜色覆盖
- 测试 `SetDiffuseColor()`

#### 第 2 行（索引 5-9）：金属度测试
- 金属度从 0.0 到 1.0
- 测试 `SetMetallic()`

#### 第 3 行（索引 10-14）：粗糙度测试
- 粗糙度从 0.0 到 1.0
- 测试 `SetRoughness()`

#### 第 4 行（索引 15-19）：透明度测试
- 不透明度从 0.3 到 1.0
- 测试 `SetOpacity()` 和透明物体排序

### 3. 视锥体裁剪测试

- 自动剔除相机不可见的对象
- 统计可见和剔除的网格数量
- 优化渲染性能

### 4. 透明物体排序测试

- 自动将透明物体（第 4 行）按深度从远到近排序
- 确保正确的渲染顺序

### 5. 相机控制测试

- 相机自动环绕场景中心旋转
- 半径 15 单位，高度 5 单位
- 每秒旋转 20 度

## 🎮 交互控制

### 键盘快捷键

- **ESC** - 退出程序
- **F1** - 打印详细统计信息
  - ECS World 统计
  - 渲染统计（可见、剔除、绘制调用）
  - 资源清理统计
  - 资源管理器统计
- **F2** - 手动触发资源清理
- **F3** - 随机切换一个 miku 的可见性

### 窗口标题信息

实时显示：
- FPS（每秒帧数）
- 快捷键提示

## 📊 统计信息

按 F1 可以查看：

### ECS World 统计
```
[World] Statistics:
  Entities: 24 (Active: 24)
  Systems: 11
  Last Update: 5.2 ms
```

### 渲染统计
```
渲染统计:
  可见网格: 22
  剔除网格: 2
  绘制调用: 22
```

### 资源清理统计
```
资源清理统计:
  清理的网格: 0
  清理的纹理: 0
  清理的材质: 0
  清理的着色器: 0
  总计清理: 0
```

### 资源管理器统计
```
资源管理器统计:
  网格: 23
  纹理: 45
  材质: 22
  着色器: 5
  总内存: 125.6 MB
```

## 🏗️ 场景布局

### 实体列表

1. **MainCamera** - 主相机
   - 自动环绕旋转
   - 视野角度 60°
   - 宽高比 16:9

2. **DirectionalLight** - 定向光源
   - 方向：(45°, 30°, 0°)
   - 颜色：暖白色
   - 强度：1.2

3. **Floor** - 地板
   - 使用 GeometrySystem 生成
   - 尺寸：30 × 0.2 × 30
   - 颜色：深灰色

4. **Miku_0 ~ Miku_19** - 20 个 miku 模型
   - 排列：4 行 × 5 列
   - 间距：3 单位
   - 不同材质覆盖

5. **Sphere** - 球体
   - 位置：(-10, 1, 0)
   - 红色金属材质

6. **Cylinder** - 圆柱体
   - 位置：(10, 1, 0)
   - 绿色半金属材质

## 🔧 编译和运行

### 编译

```bash
# 在项目根目录
mkdir build
cd build
cmake ..
cmake --build . --config Release

# 或者使用 Visual Studio 打开解决方案编译
```

### 运行

```bash
# Windows
cd build/examples/Release
./35_ecs_comprehensive_test.exe

# 或者在 Visual Studio 中设置为启动项目并运行
```

## 📝 前置条件

### 必需资源

1. **Miku 模型**
   - 路径：`assets/models/miku/miku.pmx`
   - 如果没有此模型，可以：
     - 将代码中的模型路径改为其他可用模型
     - 或注释掉 miku 创建部分，只测试几何形状

2. **着色器**
   - 自动从 `shaders/` 目录复制到可执行文件目录
   - 需要支持材质属性的着色器

### 可选资源

- 自定义纹理（用于 textureOverrides 测试）
- 其他模型文件

## 🎯 测试目标

### 功能验证

- [x] WindowSystem 正常工作
- [x] GeometrySystem 正常生成网格
- [x] UniformSystem 自动设置 uniform
- [x] ResourceCleanupSystem 正常清理
- [x] 材质属性覆盖生效
- [x] 视锥体裁剪工作正常
- [x] 透明物体正确排序
- [x] 相机自动环绕
- [x] 动态显示/隐藏实体

### 性能验证

- [x] 帧率稳定在 60 FPS 以上
- [x] 视锥体裁剪有效减少绘制调用
- [x] 内存使用稳定
- [x] 资源清理防止内存泄漏

### 视觉效果验证

- [x] 20 个 miku 正确渲染
- [x] 颜色覆盖效果正确
- [x] 金属度效果正确
- [x] 粗糙度效果正确
- [x] 透明度效果正确
- [x] 光照和阴影正确
- [x] 相机运动流畅

## 🐛 常见问题

### Q: 模型不显示

**A**: 检查以下几点：
1. miku.pmx 文件路径是否正确
2. 模型是否正确加载（查看日志）
3. 相机位置和方向是否正确
4. 光照是否正确设置

### Q: FPS 很低

**A**: 可能的原因：
1. 模型过于复杂（miku 可能有大量顶点）
2. 减少 miku 数量（修改 rows 和 cols）
3. 关闭阴影（设置 castShadows = false）
4. 降低窗口分辨率

### Q: 透明效果不正确

**A**: 确保：
1. 渲染状态启用了混合模式
2. 透明物体正确排序
3. 深度写入设置正确

### Q: 资源清理不工作

**A**: 
1. 默认每 60 秒清理一次
2. 按 F2 手动触发清理
3. 查看 F1 统计信息

## 📚 相关文档

- [ECS API 文档](../docs/api/ECS.md)
- [Component API 文档](../docs/api/Component.md)
- [System API 文档](../docs/api/System.md)
- [ECS 快速开始](../docs/ECS_QUICK_START.md)
- [ECS 实现报告](../docs/ECS_FINAL_IMPLEMENTATION_REPORT.md)

## 🎓 学习要点

通过这个测试，你可以学习：

1. **如何创建 ECS 实体**
   - 使用 `CreateEntity()` 和组件
   - 添加多个组件到实体

2. **如何注册和使用系统**
   - 注册系统时传递依赖
   - 系统优先级的重要性
   - 系统间的协作

3. **如何使用材质属性覆盖**
   - 不修改原始材质的情况下覆盖属性
   - 实现每个实体独特的外观

4. **如何使用 GeometrySystem**
   - 程序化生成几何形状
   - 避免手动创建复杂网格

5. **如何处理透明物体**
   - 透明度设置
   - 自动排序机制

6. **如何管理资源**
   - 资源自动加载
   - 资源清理和内存管理
   - 查看资源统计

## 🚀 扩展建议

可以尝试：

1. 添加更多 miku 模型（修改 rows 和 cols）
2. 添加更多几何形状测试
3. 实现用户交互相机控制
4. 添加阴影渲染测试
5. 添加后处理效果测试
6. 测试实例化渲染
7. 测试离屏渲染（Framebuffer）
8. 添加物理模拟系统
9. 添加粒子系统
10. 实现场景保存/加载

## 📄 许可

与主项目相同。

